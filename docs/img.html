<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0">
  <title>图片拼接</title>
  <link rel="stylesheet"
    type="text/css"
    href="img.css">
</head>

<body>
  <div class="btn-wrap">
    <div>
      <label class="input-btn"
        for="input">添加图片（多选）</label>
      <input type="file"
        id="input"
        multiple>
    </div>
    <input type="range"
      min="-90"
      id="range">
    <button class="save-btn"
      id="save">保存</button>
  </div>

  <div class="img-wrap">
  </div>

  <canvas id="canvas"></canvas>

  <!-- <script src="https://cdn.bootcdn.net/ajax/libs/FileSaver.js/1.0.0/FileSaver.min.js"></script> -->
  <script src="https://cdn.bootcdn.net/ajax/libs/rxjs/6.6.3/rxjs.umd.min.js"></script>
  <script src="./js/utils.js"></script>
  <script src="./js/imgClass.js"></script>
  <script>
    const $fileInput = $('#input')
    const $save = $('#save')
    const $canvas = $('#canvas')
    const $imgWrap = $('.img-wrap')
    const $rangeInput = $('#range')
    const context = canvas.getContext('2d')
    const imgList = []

    const oImgList = new ImgList($imgWrap)
    const wrapWidth = $imgWrap.offsetWidth
    let wrapHeight = $imgWrap.offsetHeight

    // const srcList = ['./img/1.jpeg', './img/2.jpeg', './img/3.png']

    // setImgs($imgWrap, srcList, (imgs) => {
    //    wrapHeight = $imgWrap.offsetHeight
    // })

    $fileInput.oninput = function () {
      const files = Array.prototype.slice.call(this.files)
      // drawCanvas(context, files)
      setImgs($imgWrap, files, (imgs) => {
        wrapHeight = $imgWrap.offsetHeight
      })

      // if (window.utools) utools.showMainWindow()
    }

    const rangeInputFn = throttle(function (e) {
      const ratio = this.value / 100 + 1
      $imgWrap.style.width = wrapWidth * ratio + 'px'

      const h = oImgList.arrange()
      $imgWrap.style.height = h + 'px'
    }, 50)

    $rangeInput.oninput = rangeInputFn

    $save.onclick = function () {
      drawCanvas(context, oImgList.getDomList())
      const $a = document.createElement('a')
      canvas.toBlob(function (blob) {
        const newFile = new File([blob], 'a.png', { type: 'image/png' })
        const formData = new FormData()
        formData.append('file', newFile)
        tyniPng(formData)
      })

      return
      $a.href = canvas.toDataURL('image/png')
      $a.download = 'long.png'
      $a.click()
    }

    // $('#canvas').toBlob(function(blob) {
    //     window.saveAs(blob, "pretty image.png");
    // })


    async function setImgs($wrap, files, afterAllImgLoaded) {
      let len = 0

      files.forEach((file) => {
        const Img = new ImgItem(typeof file === 'string' ? file : getObjectURL(file))
        oImgList.push(Img)
        $wrap.appendChild(Img.getDom())
      })

      await oImgList.allLoaded()
      const h = oImgList.arrange()
      $imgWrap.style.height = h + 'px'
    }

    function drawCanvas(ctx, imgs) {
      const q = []
      let height = 0
      let len = 0

      imgs.forEach((img) => {
        const top = height
        const w = img.offsetWidth
        const h = img.offsetHeight

        if (len === 0) $canvas.width = w

        q.push(function () {
          ctx.drawImage(img, 0, top, w, h)
        })

        height += img.height
        len++

        if (len >= imgs.length) {
          $canvas.height = height
          q.forEach(f => f())
        }
      });
    }

    function initSortImg() {
      const mouseDown$ = rxjs.fromEvent($imgWrap, 'mousedown')
      const mouseMove$ = rxjs.fromEvent(document, 'mousemove')
      const mouseUp$ = rxjs.fromEvent(document, 'mouseup')
      const mouseDownSubject$ = new rxjs.Subject()
      const mouseUpSubject$ = new rxjs.Subject()

      mouseDown$.subscribe(mouseDownSubject$)
      mouseUp$.subscribe(mouseUpSubject$)

      const moveStream$ = mouseMove$.pipe(
        rxjs.operators.map(item => [item.x, item.y]),
        rxjs.operators.takeUntil(
          mouseUpSubject$.pipe(
            rxjs.operators.tap(() => {
              oImgList.completeMove()
            })))
      )

      mouseDownSubject$.subscribe((e) => {
        const o = e.target
        const i = oImgList.findIndex(o)
        oImgList.startMove(i, { x: e.x, y: e.y })
      })

      mouseDownSubject$.pipe(
        rxjs.operators.concatMap(() => moveStream$),
      ).subscribe(
        {
          next: ([, y]) => {
            oImgList.vMove(y)
            oImgList.sort(y)
          },
        })
    }

    function tyniPng(imgBlob) {
      console.log(imgBlob)
      fetch('https://api.tynify.com', {
        headers: {
          'Authorization': 'Basic bFyDwsMCsPq0tk7B31H1xTZVvW0pztrM'
        },
        method: 'POST', // *GET, POST, PUT, DELETE, etc.
        mode: 'cors', // no-cors, cors, *same-origin
        body: imgBlob,
        processData: false,    // processData和contentType必须指定为false
        contentType: false,
      }).then(console.log).catch(console.error)
    }

    function _main() {
      initSortImg()
    }
  </script>
</body>

</html>